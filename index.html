<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Typing Garden</title>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Quicksand -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Reggio Theme Customizations */
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f5f5f0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e6e6e0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Smooth cursor animation */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        
        /* Shake animation for error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        button:focus-visible {
            outline: 2px solid #059669;
            outline-offset: 2px;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.4); 
        }

        /* Rain Drop Animation */
        .rain-drop {
            transition: top 0.1s linear;
        }
    </style>
</head>
<body class="text-stone-700 h-screen w-screen overflow-hidden flex flex-col">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">

        // ==========================================
        // TEACHER SETTINGS
        // ==========================================
        const TEACHER_SETTINGS = {
            MISTAKES_PER_HEART: 5, 
            STARTING_HEARTS: 3,
            LEVELS: [
                { title: "Sunflowers", text: "Tall sunflowers turn their bright yellow heads to follow the sun across the blue sky." },
                { title: "The River", text: "Cool water flows over smooth stones in the quiet river, making a gentle splashing sound." },
                { title: "Mountains", text: "Snow covers the high peaks of the mountains, while green pine trees grow in the valleys below." },
                { title: "Butterflies", text: "An orange butterfly rests on a purple flower, opening and closing its delicate wings." },
                { title: "Night Sky", text: "When the sun goes down, thousands of tiny stars twinkle like diamonds in the dark night sky." },
                { title: "Ocean Waves", text: "The salty ocean waves crash against the sandy shore, leaving behind seashells and smooth glass." },
                { title: "Autumn", text: "In October, the maple leaves turn bright red and orange before crunching under our feet." },
                { title: "First Snow", text: "The world becomes quiet and white as soft snowflakes fall gently from the gray clouds." },
                { title: "Rainforest", text: "Monkeys swing from vines in the thick green rainforest, calling out to each other loudly." },
                { title: "Desert Life", text: "A cactus can live for a long time without water, standing tall in the hot desert sand." },
                { title: "Morning Dew", text: "Early in the morning, tiny drops of water sparkle on the spider webs like strings of pearls." },
                { title: "The Owl", text: "The wise old owl sits high in the oak tree, watching the forest floor with big yellow eyes." },
                { title: "Busy Ants", text: "A line of tiny ants works together to carry a crumb of bread back to their underground home." },
                { title: "Gentle Wind", text: "A soft breeze blows through the tall grass, making it dance and sway in the afternoon light." },
                { title: "Deep Roots", text: "Under the ground, the roots of the tree spread out wide to drink water and hold the tree steady." },
                { title: "Fluffy Clouds", text: "White clouds float by like cotton balls, changing shapes into dragons and castles as they move." },
                { title: "Fireflies", text: "On warm summer nights, fireflies blink their yellow lights in the backyard to find their friends." },
                { title: "Mushrooms", text: "After the rain, small red mushrooms pop up from the damp earth under the shade of the ferns." },
                { title: "Coral Reef", text: "Colorful fish swim quickly through the coral reef, hiding from bigger fish in the safety of the rocks." },
                { title: "Pine Forest", text: "The air smells fresh and sharp in the pine forest, where needles cover the ground like a soft carpet." },
                { title: "The Moon", text: "Sometimes the moon looks like a thin smile, and other times it is a big, bright, round circle." },
                { title: "Spring Robins", text: "The red robin hops across the green lawn, looking for a worm to bring back to the nest." },
                { title: "River Stones", text: "Over many years, the rushing water turns rough rocks into smooth, round pebbles of gray and blue." },
                { title: "Morning Fog", text: "A thick gray fog hugs the ground, hiding the trees and houses until the sun burns it away." },
                { title: "Harvest Time", text: "Farmers gather ripe pumpkins and crisp apples as the air turns cool and the days grow shorter." }
            ],
            // Rain Game Settings
            RAIN_SPEED: 2, // Speed of falling words
            RAIN_SPAWN_RATE: 2500, // Milliseconds between new words
            ABOUT_TEXT: "Welcome to Typing Garden! Practice typing or play the Rain Shower game to water your garden. Focus on accuracy and rhythm.",
            CLASS_NAME: "Mr. Fugitt's Class"
        };

        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Shared Components ---

        const Button = React.forwardRef(({ onClick, children, variant = "primary", className = "", autoFocus = false }, ref) => {
            const baseStyle = "px-6 py-3 rounded-2xl font-semibold transition-all duration-200 transform active:scale-95 flex items-center gap-2 shadow-sm";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 hover:shadow-md",
                secondary: "bg-stone-200 text-stone-700 hover:bg-stone-300",
                danger: "bg-rose-100 text-rose-600 hover:bg-rose-200",
                ghost: "bg-transparent text-stone-500 hover:bg-stone-100"
            };
            return (
                <button 
                    ref={ref}
                    onClick={onClick} 
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                    autoFocus={autoFocus}
                >
                    {children}
                </button>
            );
        });

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="glass-panel bg-white rounded-3xl p-8 max-w-lg w-full relative animate-fade-in">
                    <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-stone-100 text-stone-400 hover:text-stone-600 transition-colors">
                        <i className="ph ph-x text-xl"></i>
                    </button>
                    <h2 className="text-2xl font-bold text-emerald-800 mb-4">{title}</h2>
                    <div className="text-stone-600 leading-relaxed">
                        {children}
                    </div>
                </div>
            </div>
        );

        const ProgressBar = ({ current, total }) => (
            <div className="w-full bg-stone-200/50 rounded-full h-1.5 md:h-2 mb-4 overflow-hidden">
                <div 
                    className="bg-emerald-400 h-full transition-all duration-300 ease-out rounded-full"
                    style={{ width: `${Math.min(100, (current / total) * 100)}%` }}
                />
            </div>
        );

        // --- Keyboard (Compact Version) ---
        const KEYBOARD_LAYOUT = [
            ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "backspace"],
            ["tab", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\"],
            ["caps", "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'", "enter"],
            ["shift", "z", "x", "c", "v", "b", "n", "m", ",", ".", "/", "shift"],
            ["space"]
        ];

        const FINGER_MAP = {
            'rose-400': ['`', '1', 'q', 'a', 'z', 'shift', 'tab', 'caps'], 
            'orange-400': ['2', 'w', 's', 'x'], 
            'amber-400': ['3', 'e', 'd', 'c'], 
            'emerald-400': ['4', '5', 'r', 't', 'f', 'g', 'v', 'b'], 
            'sky-400': ['6', '7', 'y', 'u', 'h', 'j', 'n', 'm'], 
            'blue-400': ['8', 'i', 'k', ','], 
            'indigo-400': ['9', 'o', 'l', '.'], 
            'violet-400': ['0', '-', '=', 'p', '[', ']', '\\', ';', '\'', 'enter', 'backspace', '/']
        };

        const getFingerColor = (key) => {
            if (key === 'space') return 'border-stone-300';
            for (const [color, keys] of Object.entries(FINGER_MAP)) {
                if (keys.includes(key.toLowerCase())) return `border-${color}`;
            }
            return 'border-stone-300';
        };

        const getKeyTarget = (char) => {
            if (!char) return null;
            const lower = char.toLowerCase();
            const symbolMap = {
                '~': '`', '!': '1', '@': '2', '#': '3', '$': '4', '%': '5', '^': '6', '&': '7', '*': '8', '(': '9', ')': '0', '_': '-', '+': '=',
                '{': '[', '}': ']', '|': '\\', ':': ';', '"': "'", '<': ',', '>': '.', '?': '/'
            };
            let key = symbolMap[char] || lower;
            let needsShift = false;
            if (symbolMap[char] || (char >= 'A' && char <= 'Z')) {
                needsShift = true;
            }
            return { key, needsShift };
        };

        const VirtualKeyboard = ({ nextChar }) => {
            const target = getKeyTarget(nextChar);
            const leftHandKeys = new Set(['`','1','2','3','4','5','q','w','e','r','t','a','s','d','f','g','z','x','c','v','b']);
            const useRightShift = target && leftHandKeys.has(target.key);

            return (
                <div className="w-full max-w-3xl mx-auto p-1.5 glass-panel rounded-xl mt-2 select-none">
                    <div className="flex flex-col gap-1">
                        {KEYBOARD_LAYOUT.map((row, rowIndex) => (
                            <div key={rowIndex} className="flex justify-center gap-0.5 md:gap-1">
                                {row.map((key) => {
                                    let isActive = false;
                                    if (target) {
                                        if (key.toLowerCase() === target.key) isActive = true;
                                        if (key === 'shift' && target.needsShift) {
                                            if (useRightShift && rowIndex === 3 && row.indexOf(key) > 5) isActive = true;
                                            if (!useRightShift && rowIndex === 3 && row.indexOf(key) === 0) isActive = true;
                                        }
                                        if (key === 'space' && nextChar === ' ') isActive = true;
                                    }
                                    
                                    // Much smaller sizing for Chromebooks
                                    let widthClass = "w-6 md:w-9";
                                    if (key === 'backspace') widthClass = "w-12 md:w-16";
                                    if (key === 'tab' || key === '\\') widthClass = "w-10 md:w-14";
                                    if (key === 'caps' || key === 'enter') widthClass = "w-11 md:w-14";
                                    if (key === 'shift') widthClass = "w-14 md:w-20";
                                    if (key === 'space') widthClass = "w-40 md:w-60";
                                    
                                    const fingerBorder = getFingerColor(key);
                                    
                                    return (
                                        <div 
                                            key={key}
                                            className={`
                                                h-6 md:h-9 flex items-center justify-center rounded md:rounded-lg 
                                                text-[10px] md:text-sm font-medium transition-all duration-200 shadow-sm border-b-2
                                                ${widthClass}
                                                ${isActive 
                                                    ? 'bg-emerald-500 text-white border-emerald-700 -translate-y-0.5 shadow-md' 
                                                    : `bg-white text-stone-600 ${fingerBorder} hover:bg-stone-50`
                                                }
                                            `}
                                        >
                                            {key === 'shift' ? <i className="ph-bold ph-arrow-fat-up"></i> : 
                                             key === 'backspace' ? <i className="ph-bold ph-backspace"></i> :
                                             key === 'enter' ? <i className="ph-bold ph-arrow-turn-down-left"></i> :
                                             key === 'tab' ? <i className="ph-bold ph-arrows-left-right"></i> :
                                             key === 'caps' ? <i className="ph-bold ph-caps-lock"></i> :
                                             key.toUpperCase()}
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RenderedText = ({ targetText, inputText, isError }) => {
            const cursorRef = useRef(null);
            const prevTopRef = useRef(null);

            useEffect(() => {
                if (cursorRef.current) {
                    const currentTop = cursorRef.current.offsetTop;
                    // Only scroll if line changed
                    if (prevTopRef.current !== currentTop) {
                        cursorRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        prevTopRef.current = currentTop;
                    }
                }
            }, [inputText.length]);

            return (
                <div className="font-mono text-xl md:text-3xl leading-relaxed tracking-wide text-stone-400 break-words whitespace-pre-wrap">
                    {targetText.split('').map((char, index) => {
                        let colorClass = "text-stone-300/60";
                        let cursorClass = "";
                        const isCursor = index === inputText.length;

                        if (index < inputText.length) {
                            colorClass = "text-emerald-700 font-medium"; 
                        } else if (isCursor) {
                            colorClass = isError 
                                ? "text-rose-500 bg-rose-100/50 rounded transition-colors duration-100" 
                                : "text-stone-800 underline decoration-emerald-500 decoration-2 underline-offset-4";
                            cursorClass = isError 
                                ? "border-l-2 border-rose-500 ml-[-2px]" 
                                : "cursor-blink border-l-2 border-emerald-500 ml-[-2px]"; 
                        }

                        return (
                            <span 
                                key={index} 
                                ref={isCursor ? cursorRef : null}
                                className={`${colorClass} ${cursorClass}`}
                            >
                                {char}
                            </span>
                        );
                    })}
                </div>
            );
        };

        // --- Rain Game Components ---
        
        const RainGameView = ({ setView }) => {
            const [drops, setDrops] = useState([]);
            const [activeWordId, setActiveWordId] = useState(null); // ID of word currently being typed
            const [typedPart, setTypedPart] = useState("");
            const [score, setScore] = useState(0);
            const [missed, setMissed] = useState(0);
            const [gameState, setGameState] = useState('playing'); // playing, gameover
            
            const containerRef = useRef(null);
            const lastSpawnTime = useRef(0);
            const requestRef = useRef();

            // Word pool extraction
            const wordPool = useMemo(() => {
                const words = [];
                TEACHER_SETTINGS.LEVELS.forEach(level => {
                    const clean = level.text.replace(/[^\w\s]|_/g, "").replace(/\s+/g, " ");
                    clean.split(' ').forEach(w => {
                        if(w.length > 2) words.push(w);
                    });
                });
                return [...new Set(words)]; // distinct
            }, []);

            // Game Loop
            const updateGame = useCallback((time) => {
                if (gameState !== 'playing') return;

                // Spawn logic
                if (time - lastSpawnTime.current > TEACHER_SETTINGS.RAIN_SPAWN_RATE) {
                    const word = wordPool[Math.floor(Math.random() * wordPool.length)];
                    const id = Date.now();
                    const x = Math.random() * 80 + 10; // 10% to 90% width
                    
                    setDrops(prev => [...prev, { id, text: word, x, y: -10 }]);
                    lastSpawnTime.current = time;
                }

                // Move drops & Check collisions
                setDrops(prev => {
                    const nextDrops = [];
                    let newMissed = 0;
                    
                    prev.forEach(drop => {
                        const nextY = drop.y + (TEACHER_SETTINGS.RAIN_SPEED * 0.1); // Speed factor
                        if (nextY > 100) {
                            newMissed++;
                            // Reset active if the active word dropped off screen
                            setActiveWordId(currentId => currentId === drop.id ? null : currentId);
                            setTypedPart(current => activeWordId === drop.id ? "" : current);
                        } else {
                            nextDrops.push({ ...drop, y: nextY });
                        }
                    });

                    if (newMissed > 0) {
                        setMissed(m => {
                            const nextM = m + newMissed;
                            if (nextM >= 10) setGameState('gameover');
                            return nextM;
                        });
                    }
                    
                    return nextDrops;
                });

                requestRef.current = requestAnimationFrame(updateGame);
            }, [gameState, wordPool, activeWordId]);

            useEffect(() => {
                requestRef.current = requestAnimationFrame(updateGame);
                return () => cancelAnimationFrame(requestRef.current);
            }, [updateGame]);

            // Input Handler
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (gameState !== 'playing') return;
                    if (e.key.length > 1 && e.key !== 'Backspace') return;

                    // If we have an active word
                    if (activeWordId) {
                        const activeDrop = drops.find(d => d.id === activeWordId);
                        if (!activeDrop) {
                            // Active word disappeared? Reset
                            setActiveWordId(null);
                            setTypedPart("");
                            return;
                        }

                        const nextCharNeeded = activeDrop.text[typedPart.length];
                        if (e.key === nextCharNeeded) {
                            const nextTyped = typedPart + e.key;
                            setTypedPart(nextTyped);
                            
                            // Word complete?
                            if (nextTyped === activeDrop.text) {
                                setScore(s => s + 1);
                                setDrops(prev => prev.filter(d => d.id !== activeWordId));
                                setActiveWordId(null);
                                setTypedPart("");
                            }
                        }
                    } else {
                        // Try to find a new target
                        // Find drops that start with this key
                        // Sort by Y (lowest first/closest to danger)
                        const candidates = drops.filter(d => d.text.startsWith(e.key)).sort((a, b) => b.y - a.y);
                        
                        if (candidates.length > 0) {
                            const target = candidates[0];
                            setActiveWordId(target.id);
                            setTypedPart(e.key);
                            
                            // If single letter word (unlikely but possible)
                            if (target.text.length === 1) {
                                setScore(s => s + 1);
                                setDrops(prev => prev.filter(d => d.id !== target.id));
                                setActiveWordId(null);
                                setTypedPart("");
                            }
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [drops, activeWordId, typedPart, gameState]);

            return (
                <div className="h-full w-full relative overflow-hidden bg-gradient-to-b from-sky-100 to-emerald-50">
                    {/* Header */}
                    <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-20">
                        <Button variant="ghost" onClick={() => setView('home')} className="!p-2 bg-white/50 backdrop-blur">
                            <i className="ph-bold ph-arrow-left"></i>
                        </Button>
                        <div className="flex gap-4">
                            <div className="bg-white/80 backdrop-blur px-4 py-2 rounded-full font-bold text-emerald-700 shadow-sm">
                                Score: {score}
                            </div>
                            <div className="bg-white/80 backdrop-blur px-4 py-2 rounded-full font-bold text-rose-500 shadow-sm">
                                Missed: {missed}/10
                            </div>
                        </div>
                    </div>

                    {/* Rain Area */}
                    <div ref={containerRef} className="absolute inset-0 z-10">
                        {drops.map(drop => {
                            const isActive = drop.id === activeWordId;
                            const isMatched = isActive ? drop.text.substring(0, typedPart.length) : "";
                            const remainder = isActive ? drop.text.substring(typedPart.length) : drop.text;

                            return (
                                <div 
                                    key={drop.id}
                                    className={`absolute px-3 py-1.5 rounded-full font-mono font-bold text-lg shadow-sm transition-transform
                                        ${isActive ? 'bg-emerald-500 text-white scale-110 z-20' : 'bg-white/80 text-sky-700 border border-sky-200'}
                                    `}
                                    style={{ 
                                        left: `${drop.x}%`, 
                                        top: `${drop.y}%`,
                                        transform: 'translateX(-50%)'
                                    }}
                                >
                                    {isActive ? (
                                        <>
                                            <span className="text-emerald-100">{isMatched}</span>
                                            <span>{remainder}</span>
                                        </>
                                    ) : (
                                        drop.text
                                    )}
                                    {/* Droplet Icon */}
                                    <div className="absolute -top-4 left-1/2 -translate-x-1/2 text-sky-400 opacity-50">
                                        <i className="ph-fill ph-drop text-xl"></i>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Ground */}
                    <div className="absolute bottom-0 left-0 right-0 h-16 bg-emerald-600 z-10 flex items-end justify-center pb-4">
                         <div className="text-emerald-100 font-bold opacity-50">Keep the garden watered!</div>
                    </div>

                    {/* Game Over Overlay */}
                    {gameState === 'gameover' && (
                        <div className="absolute inset-0 z-50 bg-stone-900/40 backdrop-blur flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl p-8 text-center animate-pop-in max-w-sm w-full">
                                <i className="ph-fill ph-cloud-rain text-6xl text-sky-400 mb-4"></i>
                                <h2 className="text-3xl font-bold text-stone-800 mb-2">Rain Stopped</h2>
                                <p className="text-stone-500 mb-6">You collected {score} words!</p>
                                <div className="flex gap-2 justify-center">
                                    <Button variant="secondary" onClick={() => setView('home')}>Home</Button>
                                    <Button onClick={() => {
                                        setDrops([]);
                                        setScore(0);
                                        setMissed(0);
                                        setGameState('playing');
                                        setActiveWordId(null);
                                        setTypedPart("");
                                    }}>Play Again</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        };


        // --- View Components ---

        const HomeView = ({ setView, startGame }) => (
            <div className="flex flex-col items-center justify-center h-full p-6 animate-fade-in">
                <div className="glass-panel p-8 md:p-12 rounded-[2rem] text-center max-w-2xl w-full">
                    <div className="mb-6 inline-flex p-4 bg-emerald-100 rounded-full text-emerald-600">
                        <i className="ph-fill ph-plant text-5xl md:text-6xl"></i>
                    </div>
                    <h1 className="text-3xl md:text-5xl font-bold text-emerald-900 mb-2">Typing Garden</h1>
                    <p className="text-stone-500 text-base md:text-lg mb-8">{TEACHER_SETTINGS.CLASS_NAME}</p>
                    
                    <div className="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
                        <Button onClick={startGame} className="w-full sm:w-auto justify-center">
                            <i className="ph-bold ph-play"></i> Start Typing
                        </Button>
                        <Button variant="secondary" onClick={() => setView('rain')} className="w-full sm:w-auto justify-center bg-sky-100 text-sky-700 hover:bg-sky-200">
                            <i className="ph-bold ph-cloud-rain"></i> Rain Shower
                        </Button>
                        <Button variant="secondary" onClick={() => setView('garden')} className="w-full sm:w-auto justify-center">
                            <i className="ph-bold ph-flower"></i> My Garden
                        </Button>
                    </div>

                    <div className="mt-8 flex justify-center gap-4">
                        <button onClick={() => setView('about')} className="text-stone-400 hover:text-emerald-600 text-sm font-medium flex items-center gap-1 transition-colors">
                            <i className="ph-bold ph-info"></i> About
                        </button>
                        <button onClick={() => setView('settings')} className="text-stone-400 hover:text-stone-600 text-sm font-medium flex items-center gap-1 transition-colors">
                            <i className="ph-bold ph-gear"></i> Settings
                        </button>
                    </div>
                </div>
            </div>
        );

        const GameView = ({ 
            stats, 
            setView, 
            currentLevelData, 
            currentLevelIndex, 
            isPracticeMode, 
            inputText, 
            isError, 
            gameState, 
            resetLevel, 
            nextLevel, 
            nextLevelBtnRef, 
            nextChar 
        }) => {
            const targetText = currentLevelData.text;
            return (
                <div className="flex flex-col h-full max-w-5xl mx-auto w-full p-2">
                    {/* Header Stats - Compact */}
                    <div className="flex justify-between items-center mb-2 glass-panel p-2 rounded-xl">
                        <Button variant="ghost" onClick={() => setView('home')} className="!p-1.5 text-sm">
                            <i className="ph-bold ph-arrow-left text-lg"></i> Back
                        </Button>
                        
                        <div className="flex gap-4 md:gap-8 text-center">
                            <div>
                                <div className="text-[9px] md:text-[10px] font-bold text-stone-400 uppercase tracking-wider">Speed</div>
                                <div className="text-lg md:text-xl font-bold text-emerald-700">{stats.wpm} <span className="text-xs font-normal text-stone-500">wpm</span></div>
                            </div>
                            <div>
                                <div className="text-[9px] md:text-[10px] font-bold text-stone-400 uppercase tracking-wider">Accuracy</div>
                                <div className="text-lg md:text-xl font-bold text-emerald-700">{Math.round(((targetText.length - stats.mistakes) / targetText.length) * 100) || 100}%</div>
                            </div>
                            <div className="hidden sm:block">
                                <div className="text-[9px] md:text-[10px] font-bold text-stone-400 uppercase tracking-wider">Hearts</div>
                                <div className="flex gap-0.5 mt-0.5 text-rose-500 text-lg">
                                    {[...Array(TEACHER_SETTINGS.STARTING_HEARTS)].map((_, i) => (
                                        <i key={i} className={`ph-fill ${i < stats.hearts ? 'ph-heart' : 'ph-heart-break text-stone-300'}`}></i>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="w-10"></div>
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 flex flex-col justify-center relative min-h-0">
                        <div className={`glass-panel p-4 md:p-8 rounded-2xl shadow-lg relative overflow-hidden flex flex-col justify-center transition-transform ${isError ? 'animate-shake' : ''} mb-2 flex-1`}>
                            
                            <i className="ph-fill ph-plant absolute -bottom-4 -left-4 text-emerald-100/50 text-[80px] md:text-[120px] -z-10 rotate-12"></i>
                            <i className="ph-fill ph-flower-tulip absolute top-4 right-4 text-amber-100/50 text-[60px] md:text-[80px] -z-10 -rotate-12"></i>

                            <div className="mb-2">
                                <div className="flex justify-between items-end border-b border-stone-100 pb-1 mb-2">
                                    <div className="flex flex-col">
                                        <h3 className="text-sm md:text-lg font-bold text-stone-500 uppercase tracking-widest truncate max-w-[200px]">{currentLevelData.title}</h3>
                                        {isPracticeMode && <span className="text-[10px] text-emerald-600 font-bold bg-emerald-100 px-1.5 py-0.5 rounded-full w-fit">Practice</span>}
                                    </div>
                                    <div className="text-xs text-stone-400">Level {currentLevelIndex + 1}</div>
                                </div>
                                <ProgressBar current={inputText.length} total={targetText.length} />
                            </div>

                            <div className="relative no-select overflow-y-auto max-h-[40vh] md:max-h-[30vh]" onClick={() => { document.body.focus() }}>
                                <RenderedText targetText={targetText} inputText={inputText} isError={isError} />
                            </div>
                        </div>

                        {/* Keyboard Component */}
                        <div className="hidden md:block">
                            <VirtualKeyboard nextChar={nextChar} />
                        </div>
                        
                        {/* Overlays */}
                        {stats.hearts === 0 && (
                            <div className="absolute inset-0 z-30 flex items-center justify-center p-4">
                                <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl shadow-2xl flex flex-col items-center justify-center animate-fade-in border border-rose-100 max-w-md w-full text-center">
                                    <i className="ph-fill ph-heart-break text-6xl text-rose-400 mb-4"></i>
                                    <h2 className="text-3xl font-bold text-stone-700 mb-2">Needs more care</h2>
                                    <p className="text-stone-500 mb-6">Too many mistakes. Let's try growing this again.</p>
                                    <Button onClick={resetLevel} className="w-full justify-center">Try Again</Button>
                                </div>
                            </div>
                        )}

                        {gameState === 'finished' && (
                            <div className="absolute inset-0 z-30 flex items-center justify-center p-4">
                                <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl shadow-2xl flex flex-col items-center justify-center animate-fade-in border border-emerald-100 max-w-lg w-full text-center">
                                    <i className="ph-fill ph-star text-6xl text-amber-400 mb-4 animate-bounce"></i>
                                    <h2 className="text-3xl font-bold text-emerald-800 mb-2">Beautiful!</h2>
                                    <p className="text-stone-500 mb-6 text-lg">You grew a new plant for your garden.</p>
                                    
                                    <div className="flex gap-8 mb-8">
                                        <div className="text-center">
                                            <div className="text-sm text-stone-400 uppercase">WPM</div>
                                            <div className="text-3xl font-bold text-stone-700">{stats.wpm}</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-sm text-stone-400 uppercase">Accuracy</div>
                                            <div className="text-3xl font-bold text-stone-700">{Math.round(((targetText.length - stats.mistakes) / targetText.length) * 100)}%</div>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 w-full">
                                        <Button variant="secondary" onClick={() => setView('garden')} className="flex-1 justify-center">Visit Garden</Button>
                                        <Button 
                                            ref={nextLevelBtnRef}
                                            onClick={nextLevel} 
                                            className="flex-1 justify-center"
                                            autoFocus={true}
                                        >
                                            Next Level <i className="ph-bold ph-arrow-right"></i>
                                        </Button>
                                    </div>
                                    {isPracticeMode && <p className="mt-4 text-xs text-stone-400">Practice Mode: Repeating levels</p>}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PLANT_ICONS = ["ph-flower", "ph-plant", "ph-tree", "ph-leaf", "ph-flower-lotus", "ph-cactus", "ph-potted-plant", "ph-clover"];
        
        const GardenView = ({ userData, setView, replayLevel }) => (
            <div className="h-full flex flex-col p-6 max-w-6xl mx-auto w-full">
                <div className="flex justify-between items-center mb-8">
                    <h2 className="text-3xl font-bold text-emerald-800">My Garden</h2>
                    <Button variant="secondary" onClick={() => setView('home')}>Back Home</Button>
                </div>

                <div className="flex-1 glass-panel rounded-3xl p-8 relative overflow-hidden bg-gradient-to-b from-blue-50/50 to-emerald-50/50 border-2 border-stone-100 overflow-y-auto">
                    <div className="absolute top-8 right-8 w-24 h-24 bg-amber-200 rounded-full blur-2xl opacity-60"></div>

                    {userData.gardenPlants.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-full text-center opacity-60">
                            <i className="ph-duotone ph-shovel text-6xl text-stone-300 mb-4"></i>
                            <p className="text-xl text-stone-500">Your garden is empty.</p>
                            <p className="text-stone-400">Complete levels to plant seeds!</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-8 pb-12">
                            {userData.gardenPlants.map((plant, index) => {
                                const iconIndex = plant.id % PLANT_ICONS.length;
                                const icon = PLANT_ICONS[iconIndex];

                                return (
                                    <div 
                                        key={index} 
                                        className="flex flex-col items-center gap-2 animate-pop-in group cursor-pointer relative"
                                        onClick={() => replayLevel(plant.id)}
                                        title={`Replay "${plant.title}"`}
                                    >
                                        <div className="w-24 h-24 bg-white/60 rounded-full flex items-center justify-center shadow-sm group-hover:scale-110 group-hover:bg-white transition-all duration-300 border border-white relative z-10 group-hover:shadow-md">
                                            <i className={`ph-fill ${icon} text-5xl text-emerald-600 drop-shadow-sm`}></i>
                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/10 rounded-full">
                                                <i className="ph-fill ph-play text-white text-3xl"></i>
                                            </div>
                                        </div>
                                        <div className="text-center z-10">
                                            <div className="text-sm font-bold text-stone-700 leading-tight mb-1">{plant.title}</div>
                                            <div className="flex gap-2 justify-center text-[10px] text-stone-500 font-mono bg-white/50 rounded-full px-2 py-0.5">
                                                <span>{plant.wpm}wpm</span>
                                                <span className="text-stone-300">|</span>
                                                <span>{plant.accuracy}%</span>
                                            </div>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                    <div className="fixed bottom-0 left-0 right-0 h-12 bg-emerald-100/50 border-t border-emerald-200/50 pointer-events-none"></div>
                </div>
            </div>
        );

        const SettingsModal = ({ setView, resetAllProgress }) => (
            <Modal title="Settings" onClose={() => setView('home')}>
                <div className="space-y-6">
                    <div className="bg-rose-50 p-4 rounded-xl border border-rose-100">
                        <h4 className="font-bold text-rose-700 mb-2 flex items-center gap-2">
                            <i className="ph-bold ph-warning"></i> Reset Progress
                        </h4>
                        <p className="text-sm text-stone-600 mb-4">
                            This will erase all badges, garden plants, and stats. This cannot be undone.
                        </p>
                        <Button variant="danger" onClick={resetAllProgress} className="w-full justify-center text-sm">
                            Erase All Data
                        </Button>
                    </div>
                    <div className="text-xs text-stone-400 text-center">
                        Version 2.2 (Rain Shower)
                    </div>
                </div>
            </Modal>
        );

        const AboutModal = ({ setView }) => (
            <Modal title="About" onClose={() => setView('home')}>
                <p className="mb-4">{TEACHER_SETTINGS.ABOUT_TEXT}</p>
                <div className="bg-emerald-50 p-4 rounded-xl">
                    <h4 className="font-bold text-emerald-800 text-sm mb-2">Rain Shower Mode:</h4>
                    <ul className="text-sm space-y-2 list-disc list-inside">
                        <li>Words will fall from the sky!</li>
                        <li>Type the <b>first letter</b> of a word to target it.</li>
                        <li>Finish typing the word before it hits the bottom.</li>
                        <li>Don't let too many words fall!</li>
                    </ul>
                </div>
            </Modal>
        );

        // --- Main App Component ---

        function App() {
            const [view, setView] = useState('home');
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            
            const [inputText, setInputText] = useState("");
            const [gameState, setGameState] = useState("ready");
            const [stats, setStats] = useState({ wpm: 0, accuracy: 100, mistakes: 0, hearts: TEACHER_SETTINGS.STARTING_HEARTS });
            const [startTime, setStartTime] = useState(null);
            const [isError, setIsError] = useState(false);
            
            const nextLevelBtnRef = useRef(null);
            const inputTextRef = useRef("");

            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('typingGardenData');
                let parsed;
                try {
                    parsed = saved ? JSON.parse(saved) : null;
                    if (parsed && parsed.gardenPlants && parsed.gardenPlants.length > 0 && typeof parsed.gardenPlants[0] === 'number') {
                        parsed = null;
                    }
                } catch (e) {
                    parsed = null;
                }

                return parsed || { 
                    unlockedBadges: [], 
                    levelsCompleted: 0, 
                    totalWordsTyped: 0,
                    gardenPlants: []
                };
            });

            useEffect(() => {
                localStorage.setItem('typingGardenData', JSON.stringify(userData));
            }, [userData]);

            useEffect(() => {
                inputTextRef.current = inputText;
            }, [inputText]);

            useEffect(() => {
                if (gameState === 'finished' && nextLevelBtnRef.current) {
                    setTimeout(() => nextLevelBtnRef.current.focus(), 100);
                }
            }, [gameState]);

            const levelDataIndex = currentLevelIndex % TEACHER_SETTINGS.LEVELS.length;
            const currentLevelData = TEACHER_SETTINGS.LEVELS[levelDataIndex];
            const targetText = currentLevelData.text;
            const isPracticeMode = currentLevelIndex >= TEACHER_SETTINGS.LEVELS.length;

            const nextChar = inputText.length < targetText.length ? targetText[inputText.length] : null;

            const handleKeyDown = (e) => {
                if (view !== 'game' || gameState === 'finished' || gameState === 'paused') return;
                
                if (e.key === ' ' && e.target === document.body) {
                    e.preventDefault(); 
                }

                if (e.key.length > 1) return;

                if (gameState === 'ready') {
                    setGameState('playing');
                    setStartTime(Date.now());
                }

                const nextChar = e.key;
                const currentIndex = inputText.length;

                if (currentIndex >= targetText.length) return;

                const expectedChar = targetText[currentIndex];

                if (nextChar === expectedChar) {
                    const nextInput = inputText + nextChar;
                    setInputText(nextInput);
                    setIsError(false);

                    if (nextInput.length === targetText.length) {
                        finishLevel();
                    }
                } else {
                    setStats(prev => {
                        const newMistakes = prev.mistakes + 1;
                        let newHearts = prev.hearts;
                        if (TEACHER_SETTINGS.MISTAKES_PER_HEART > 0 && newMistakes % TEACHER_SETTINGS.MISTAKES_PER_HEART === 0) {
                            newHearts = Math.max(0, prev.hearts - 1);
                        }
                        return { ...prev, mistakes: newMistakes, hearts: newHearts };
                    });
                    
                    setIsError(true);
                    setTimeout(() => setIsError(false), 200);
                }
            };

            useEffect(() => {
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [inputText, gameState, view, currentLevelIndex]);

            useEffect(() => {
                let interval;
                if (gameState === 'playing' && startTime) {
                    interval = setInterval(() => {
                        const now = Date.now();
                        const minutes = (now - startTime) / 60000;
                        const words = inputTextRef.current.length / 5;
                        const wpm = Math.round(words / minutes) || 0;
                        
                        setStats(prev => ({ ...prev, wpm }));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, startTime]); 

            const finishLevel = () => {
                setGameState('finished');
                
                const finalAccuracy = Math.max(0, Math.round(((targetText.length - stats.mistakes) / targetText.length) * 100));
                
                const now = Date.now();
                const minutes = (now - startTime) / 60000;
                const words = targetText.length / 5;
                const finalWpm = Math.round(words / minutes) || 0;
                
                setStats(prev => ({ ...prev, wpm: finalWpm, accuracy: finalAccuracy }));

                setUserData(prev => {
                    const newPlants = [...prev.gardenPlants];
                    const existingIndex = newPlants.findIndex(p => p.id === currentLevelIndex);
                    
                    const newPlantEntry = {
                        id: currentLevelIndex,
                        title: currentLevelData.title,
                        wpm: finalWpm,
                        accuracy: finalAccuracy
                    };

                    if (existingIndex >= 0) {
                        newPlants[existingIndex] = newPlantEntry;
                    } else {
                        newPlants.push(newPlantEntry);
                    }

                    return {
                        ...prev,
                        levelsCompleted: prev.levelsCompleted + 1,
                        totalWordsTyped: prev.totalWordsTyped + (targetText.split(' ').length),
                        gardenPlants: newPlants
                    };
                });
            };

            const resetLevel = () => {
                setInputText("");
                setStats({ wpm: 0, accuracy: 100, mistakes: 0, hearts: TEACHER_SETTINGS.STARTING_HEARTS });
                setGameState("ready");
                setStartTime(null);
                setIsError(false);
            };
            
            const nextLevel = () => {
                setCurrentLevelIndex(prev => prev + 1);
                resetLevel();
            };

            const startRandomGame = () => {
                const randomIdx = Math.floor(Math.random() * TEACHER_SETTINGS.LEVELS.length);
                setCurrentLevelIndex(randomIdx);
                resetLevel();
                setView('game');
            };

            const replayLevel = (levelId) => {
                setCurrentLevelIndex(levelId);
                resetLevel();
                setView('game');
            };

            const resetAllProgress = () => {
                if(confirm("Are you sure you want to reset all garden progress? This cannot be undone.")) {
                    const cleanState = { 
                        unlockedBadges: [], 
                        levelsCompleted: 0, 
                        totalWordsTyped: 0,
                        gardenPlants: []
                    };
                    setUserData(cleanState);
                    localStorage.setItem('typingGardenData', JSON.stringify(cleanState));
                    setView('home');
                    setCurrentLevelIndex(0);
                    resetLevel();
                }
            };

            return (
                <div className="h-full w-full">
                    {view === 'home' && <HomeView setView={setView} startGame={startRandomGame} />}
                    
                    {view === 'game' && (
                        <GameView 
                            stats={stats}
                            setView={setView}
                            currentLevelData={currentLevelData}
                            currentLevelIndex={currentLevelIndex}
                            isPracticeMode={isPracticeMode}
                            inputText={inputText}
                            isError={isError}
                            gameState={gameState}
                            resetLevel={resetLevel}
                            nextLevel={nextLevel}
                            nextLevelBtnRef={nextLevelBtnRef}
                            nextChar={nextChar}
                        />
                    )}

                    {view === 'rain' && <RainGameView setView={setView} />}

                    {view === 'garden' && <GardenView userData={userData} setView={setView} replayLevel={replayLevel} />}
                    
                    {view === 'settings' && <SettingsModal setView={setView} resetAllProgress={resetAllProgress} />}
                    
                    {view === 'about' && <AboutModal setView={setView} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
